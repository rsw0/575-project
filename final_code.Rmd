---
title: "final_code"
author: "575 C1 Team 3"
date: "2020/11/11"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r load, message=FALSE}
# loading packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(modelr))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(GGally))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(sjPlot))
suppressPackageStartupMessages(library(solitude))
# loading datasets
fb <- read_delim("dataset_Facebook.csv", delim = ";")
fb <- fb[complete.cases(fb), ] %>% mutate(Category = as.factor(Category), Paid = as.factor(Paid), Month = as.factor(Month), Weekday = as.factor(Weekday), Hour = as.factor(Hour))
fb <- tibble::rowid_to_column(fb, "ID")

# center titles for ggplot
theme_update(plot.title = element_text(hjust = 0.5))
```



```{r boxplots}
# construct boxplots and identify outliers
png("box_type.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(Type, Consumers)) + scale_y_log10() + geom_point(aes(color=Type), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("box_cate.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(Category, Consumers)) + scale_y_log10() + geom_point(aes(color=Category), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("box_mont.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(as.factor(Month), Consumers)) + scale_y_log10() + geom_point(aes(color=as.factor(Month)), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("box_week.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(as.factor(Weekday), Consumers)) + scale_y_log10() + geom_point(aes(color=as.factor(Weekday)), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("box_hour.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(as.factor(Hour), Consumers)) + scale_y_log10() + geom_point(aes(color=as.factor(Hour)), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("box_paid.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes(Paid, Consumers)) + scale_y_log10() + geom_point(aes(color=Paid), alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

png("boxplot_outlier.png", width = 6, height = 4, units = 'in', res = 300)
fb %>% ggplot(aes("", Consumers)) + scale_y_log10() + geom_point(alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

# find the min of the output and filter out all observations greater than that mean
IQR_outliers <- boxplot.stats(fb$Consumers, coef = 1.5)$out
min(IQR_outliers)

fb.IQR <- fb %>% filter(Consumers < 1921)
```



```{r iforest}
# isolation forest with default parameters
iforest<- isolationForest$new()
fb.input <- fb %>% select(Page_T_Likes:Paid, Consumers)
iforest$fit(fb.input)

# predict outliers within dataset
fb.input$pred <- iforest$predict(fb.input)

# finding the distribution of average depth and excluding points with an average depth beyond 2 standard deviation, which considers 95% of all observations
mean_depth <- mean(fb.input$pred$average_depth)
sd_depth <- sd(fb.input$pred$average_depth)
temp <- mean_depth - 3*sd_depth

fb.input$outlier <- as.factor(ifelse(fb.input$pred$average_depth < temp, "outlier", "normal"))

# form the cleaned dataset derived from isolation forest
fb.input <- tibble::rowid_to_column(fb.input, "ID")
fb.iso <- fb.input %>% filter(pred$average_depth >= temp) %>% select(ID:Consumers)

# iforest boxplot
png("iforest_outlier.png", width = 6, height = 4, units = 'in', res = 300)
fb.iso %>% ggplot(aes("", Consumers)) + geom_point(alpha=0.2, position='jitter') + geom_boxplot(outlier.size=5, outlier.colour="blue", alpha=0.1)
dev.off()

fb.iso <- fb.iso %>% select(ID)
```



```{r form_clean}
# combine iforest and boxplot results to form clean dataset
fb.clean <- inner_join(fb.IQR, fb.iso, by = "ID")
```



```{r cov, message=FALSE}
# scatter matrix
png("matrix.png", width = 6, height = 4, units = 'in', res = 300)
fb.clean %>% select(Page_T_Likes, Type, Category, Month, Weekday, Hour, Paid, Consumers) %>% transmute(Page_Likes = Page_T_Likes, Type, Category = as.numeric(Category), Month = as.numeric(Month), Weekday = as.numeric(Weekday), Hour = as.numeric(Hour), Paid = as.numeric(Paid), Consumers) %>% ggpairs(lower = list(continuous = wrap("points", alpha = 0.3, size=0.1, label = abbreviate)), upper = list(continuous = wrap("cor", size = 2))) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), strip.placement = "outside", text = element_text(size = 6))
dev.off()
```



```{r MLS}
m.mls <- lm(Consumers ~ Type + Month -1, data = fb.clean)
summary(m.mls)
cooksd <- cooks.distance(m.mls)
plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels

```

```{r MLStable, eval=FALSE}
tab_model(m.mls, show.se = TRUE, show.std = TRUE, show.stat = TRUE)
```



```{r residual6000}
# first build residual from quadratic model to compare against mls
m.qls1 <- fb.clean %>% filter(Consumers <= 6000) %>% lm(Consumers ~ Page_T_Likes + I(Page_T_Likes^2), .)
StanResQLS1 <- rstandard(m.qls1)

# standardize for mls and plotting
m.mls1 <- fb.clean %>% filter(Consumers <= 6000) %>% lm(Consumers ~ Page_T_Likes + Type + Paid, .)
StanResMLS1 <- rstandard(m.mls1)
png("stdres.png", width = 6, height = 4, units = 'in', res = 300)
fb.clean %>% filter(Consumers <= 6000) %>% ggplot() + geom_point(aes(Consumers, StanResQLS1, color = "Quadratic"), size = 0.1) + geom_point(aes(Consumers, StanResMLS1, color = "MLS"), size = 0.1) +
geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
scale_color_manual(name = element_blank(), labels = c("MLS","Quadratic"), values = c("red","blue")) +
labs(y = "Standarized Residual") + ggtitle("Standarized Residuals Plot")
dev.off()

# fitted residuals
qfit1 = fitted(m.qls1)
mfit1 = fitted(m.mls1)

png("fitres.png", width = 6, height = 4, units = 'in', res = 300)
fb.clean %>% filter(Consumers <= 6000) %>% ggplot() + geom_point(aes(qfit1, StanResQLS1, color = "Quadratic"), size = 0.1) + geom_point(aes(mfit1, StanResMLS1, color = "MLS"), size = 0.1) +
geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
scale_color_manual(name = element_blank(), labels = c("MLS","Quadratic"), values = c("red","blue")) +
labs(y = "Standarized Residual") + labs(x = "Fitted value") +
ggtitle("Standarized Residuals Plot (Fitted) ")
dev.off()
```

```{r qqhisto}
png("qq.png", width = 6, height = 4, units = 'in', res = 300)
p <- ggplot(data.frame(StanResMLS1), aes(sample = StanResMLS1)) +
ggtitle("QQ MLS Plot")
p + stat_qq(size = 1) + stat_qq_line()
dev.off()

png("his30.png", width = 6, height = 4, units = 'in', res = 300)
ggplot(data = data.frame(StanResMLS1), aes(x = StanResMLS1)) + geom_histogram(bins = 30) + labs(x = "Standardized Residuals") + ggtitle("Histogram MLS Plot 30 bin")
dev.off()

png("his60.png", width = 6, height = 4, units = 'in', res = 300)
ggplot(data = data.frame(StanResMLS1), aes(x = StanResMLS1)) + geom_histogram(bins = 60) + labs(x = "Standardized Residuals") + ggtitle("Histogram MLS Plot 60 bin")
dev.off()
```

```{r training}
# random sample and training
fb.random = fb.clean[sample(nrow(fb.clean)),]
fb.train <- fb.random[1:248,]
fb.validation <- fb.random[249:495,]
m.mls_train <- lm(Consumers ~ Page_T_Likes + Type + Paid - 1, data = fb.train)
ResMLS_train <- resid(m.mls_train)
```



```{r validation}
# residual for validation
output <- predict(m.mls_train, se.fit = TRUE, newdata=data.frame(Page_T_Likes=fb.validation$Page_T_Likes, Type=fb.validation$Type, Paid=fb.validation$Paid))
ResMLSValidation <- fb.validation$Consumers - output$fit

# MSE of data
mean(fb.validation$Consumers)

# Remove outliers
ResMLS_tn <- ResMLS_train[ResMLS_train<max(ResMLS_train)]
mean((ResMLS_tn)^2)

# MSE
mean((ResMLSValidation)^2)

# relative MSE
mean((ResMLSValidation)^2) / mean((fb.validation$Consumers)^2)

# RMSE
sqrt(mean((ResMLS_tn)^2))
sqrt(mean((ResMLSValidation)^2))

# validation observation with predictions
test = data.frame(fb.validation$Consumers,output$fit, 1:length(output$fit));
colnames(test)[1] = "Consumers"
colnames(test)[2] = "Prediction"
colnames(test)[3] = "Index"

# Consumers vs Prediction for validation dataset
png("validation_line.png", width = 6, height = 4, units = 'in', res = 300)
test %>% filter(Consumers <= 6000) %>% ggplot(aes(x = Consumers, y = Prediction)) + geom_point() + geom_abline(intercept = 0, slope = 1) + ggtitle("Validation Consumers vs Prediction")
dev.off()

# further analysis
png("tv_line.png", width = 6, height = 4, units = 'in', res = 300)
ggplot(data = test, aes(x = Index)) + geom_line(aes(y = Consumers, color = "Consumers")) + geom_line(aes(y = Prediction, color="Prediction"), linetype="twodash") + scale_color_manual(name = element_blank(), labels = c("Consumers","Prediction"), values = c("darkred", "steelblue")) + labs(y = "") + ggtitle("Validation")
dev.off()

# zoom
png("tv_line_zoom.png", width = 6, height = 4, units = 'in', res = 300)
test2 = test[60:120,]
ggplot(data = test2, aes(x = Index)) + geom_line(aes(y = Consumers, color = "Consumers")) + geom_line(aes(y = Prediction, color="Prediction"), linetype="twodash") + scale_color_manual(name = element_blank(), labels = c("Consumers","Prediction"), values = c("darkred", "steelblue")) + labs(y = "") +ggtitle("Validation Zoom")
dev.off()
```

```{r MSEprocess, eval=FALSE}
# the data below were obtained and recorded directly from code output in the previous step
Trial_ID <- c("1", "2", "3", "4", "5", "6", "7", "Overall Mean")
Validation_Response_Mean = c(809.6721, 779.7206, 784.5263, 767.0567, 784.3522, 796.4777, 748.834, 781.5199)
MSE_Training <- c(273935.7, 398845.9, 360237.5, 454073.8, 383966.2, 370935.7, 375185, 373882.8)
MSE_Validation <- c(495420.7, 420692.1, 776658.9, 307866.7, 368122.6, 755248.4, 384575.2, 501226.4)
RMSE_Training <- c(523.3887, 631.5425, 600.1979, 673.85, 619.6501, 609.0449, 612.5235, 610.0282)
RMSE_Validation <- c(703.8613, 648.6078, 881.2825, 554.8573, 606.7311, 869.0503, 620.1413, 697.7902)
Relative_MSE <- c(0.3678892, 0.3584252, 0.520274, 0.2964047, 0.3123263, 0.4998025, 0.3414394, 0.385223)
MSE_out <- tibble(Trial_ID, Validation_Response_Mean, MSE_Training, MSE_Validation, RMSE_Training, RMSE_Validation, Relative_MSE)
MSE_out %>% kbl(caption = "MSE Output") %>% kable_classic(full_width = F, html_font = "Cambria")
```
